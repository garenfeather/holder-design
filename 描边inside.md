# 多Stroke版本Inside PSD生成技术方案

## 概述
本方案基于现有的PNG抽取和重组流程，在inside PSD生成过程中增加多stroke版本支持，用户可自定义多个不同宽度的描边版本，提供灵活的模板选择和编辑对比功能。

## 核心需求
1. **多版本配置**：用户上传模板时可配置0-5个不同宽度的stroke版本
2. **简化预览**：预览区域仅显示原始模板，文字提示stroke版本数量
3. **编辑对比**：编辑图片时可选择不同stroke版本的透明预览图作为参考

## 技术架构

### 现有流程分析
当前inside生成流程位于`backend/processor_core.py`的`_generate_restored_psd()`方法中，包含两个核心步骤：

1. **InsideTransformer**: `backend/transformer_inside.py`对part图层进行翻转和移动变换
2. **PSDCropper**: `backend/psd_cropper.py`按view图层尺寸裁剪最终的inside PSD

完整流程：`原始PSD → InsideTransformer → 临时PSD → PSDCropper → 最终inside PSD`

### 新增多stroke流程
基于现有inside生成流程，在生成inside PSD后增加描边版本生成：

```
原始PSD → 现有inside流程 → inside PSD (原始版本)
                                    ↓
                     PNG提取 (PSDScaler.extract_layers_from_psd)
                                    ↓
                     part图层描边 (png_edge_stroke.py)
                                    ↓
                     PSD重组 (PSDScaler.create_psd_from_dir)
                                    ↓
                              inside PSD (描边版本)
```

**技术依赖**:
- 利用`backend/psd_scaler.py`的PNG提取和重组能力
- 在backend目录下复现edge脚本的成熟描边算法（不直接依赖scripts）
- 在原有流程基础上扩展，零风险添加描边功能

## 详细实现方案

### 1. 前端交互修改

#### 1.1 上传界面改造
- **Stroke配置管理区域**：在上传框上方新增stroke配置一览表
- **动态添加功能**：点击"+"按钮可添加新的stroke配置项（最多5个）
- **配置项内容**：每个配置项包含stroke宽度输入框（像素单位）和删除按钮
- **验证逻辑**：stroke宽度范围限制（1-10像素），重复宽度检测

#### 1.2 预览界面调整
- **原始模板显示**：预览区域显示原始模板图
- **Stroke版本列表**：在预览图旁显示配置的stroke版本数值（如：3px、5px、11px）
- **版本标识**：每个stroke版本显示具体像素数值，无需显示预览图

#### 1.3 编辑对比功能扩展
- **对比选项扩展**：在现有对比功能基础上增加stroke版本选择
- **透明预览图**：为每个stroke版本生成半透明预览图供对比参考
- **版本标识**：清晰标注每个对比选项的stroke宽度信息

### 2. 后端逻辑修改

#### 2.1 多版本生成逻辑详细步骤

##### 2.1.1 输入参数处理
1. **接收用户配置**：获取stroke宽度数组（如：[2, 5, 8]）
2. **参数验证**：检查数组长度不超过5个，每个宽度值在1-10像素范围内
3. **去重处理**：移除重复的宽度值，按数值大小排序
4. **配置存储**：将有效的stroke配置保存到元数据中

##### 2.1.2 原始inside版本生成
**复用现有inside生成流程**：
1. **调用现有流程**：使用`processor_core._generate_restored_psd()`生成标准inside PSD
2. **流程包含**：
   - InsideTransformer: part图层翻转和移动变换
   - PSDCropper: 按view图层尺寸裁剪
3. **文件保存**：保存为`{template_id}_restored.psd`（保持现有命名规范）
4. **路径记录**：将原始版本文件路径添加到返回结果中

##### 2.1.3 stroke版本批量生成
**对每个stroke宽度值执行以下步骤：**

1. **PNG图层提取**：
   - 使用`PSDScaler.extract_layers_from_psd()`从已生成的inside PSD中提取所有图层为PNG
   - 保持图层的正确位置、尺寸和透明度信息
   - 临时存储到`storage/inside/temp/stroke_{width}px/extracted/`

2. **part图层描边处理**：
   - 遍历提取的part1、part2、part3、part4 PNG文件
   - 使用`backend/png_stroke_processor.py`中的`PNGStrokeProcessor`类对每个part PNG进行描边
   - 描边参数：宽度为当前stroke值，颜色为白色，外侧描边模式
   - 保存描边后的PNG到`storage/inside/temp/stroke_{width}px/stroked/`
   - view图层保持不变，直接复制

3. **PSD重组生成**：
   - 使用`PSDScaler.create_psd_from_dir()`将描边后的PNG重新组装为PSD
   - 保持原有图层顺序和属性
   - 文件命名：`{template_id}_stroke_{width}px.psd`
   - 存储到`storage/inside/`目录

4. **路径记录**：将stroke版本文件路径添加到返回结果中

> **性能优化机会**: 该步骤与参考图生成存在PNG提取重复，将在第三阶段进行优化。

##### 2.1.4 透明预览图生成
**对每个stroke版本执行：**

1. **预览图抽取**：从stroke版本PSD中抽取合成预览图
2. **透明度处理**：将预览图的不透明度调整为50%
3. **预览图保存**：保存为`{template_name}_stroke_{width}px_preview.png`
4. **预览图路径记录**：将预览图路径添加到元数据中

##### 2.1.5 元数据管理
1. **配置信息整理**：
   - 记录所有生成的stroke宽度值
   - 记录原始版本和各stroke版本的文件路径
   - 记录各stroke版本对应的预览图路径
   - 记录生成时间戳和模板ID
2. **元数据文件创建**：将配置信息保存为JSON格式的元数据文件
3. **元数据存储**：保存到`storage/inside/metadata/`目录

##### 2.1.6 临时文件清理
1. **自动清理机制**：使用`tempfile.TemporaryDirectory`确保临时文件自动清理
2. **分阶段清理**：每个stroke版本处理完成后立即清理中间文件
3. **异常处理**：在异常情况下也能确保临时文件被正确清理
4. **内存优化**：释放处理过程中占用的内存资源，避免内存泄漏

##### 2.1.7 结果返回
1. **路径信息整理**：
   - 原始inside版本路径
   - 各stroke版本路径映射（宽度值 -> 文件路径）
   - 各stroke版本预览图路径映射
2. **状态信息**：返回生成成功的版本数量和任何错误信息
3. **元数据路径**：返回元数据文件路径供前端查询

#### 2.2 API接口调整
- **参数结构修改**：接收stroke配置数组而非单个配置
- **返回结果扩展**：返回原始版本路径 + 多个stroke版本路径映射
- **预览图生成**：为每个stroke版本生成透明度预览图供编辑时对比使用

#### 2.3 图片处理时的版本选择
- **版本选择参数**：在图片处理API中增加stroke版本选择参数
- **透明预览支持**：提供stroke版本的透明叠加预览功能

### 3. 存储结构调整

#### 3.1 文件命名和组织
- **原始版本**：`{template_name}_inside_original.psd`
- **多个stroke版本**：`{template_name}_inside_stroke_2px.psd`, `{template_name}_inside_stroke_5px.psd`等
- **预览图文件**：对应的透明预览图文件用于编辑时对比

#### 3.2 元数据结构扩展
- **stroke配置数组**：记录用户配置的所有stroke宽度
- **文件路径映射**：维护每个stroke宽度对应的文件路径
- **预览图路径**：记录每个版本对应的透明预览图路径

### 4. 用户体验设计

#### 4.1 配置管理交互
- **直观的添加/删除**：简单的UI操作添加和移除stroke配置
- **实时验证提示**：输入验证和重复检测的即时反馈
- **配置预览**：可选的stroke效果小图标预览

#### 4.2 编辑时的版本对比
- **版本切换**：便捷的stroke版本切换功能
- **透明叠加**：可调节透明度的叠加对比效果
- **版本标识**：清晰的版本标签和宽度显示

## 实现阶段划分

### 第一阶段：多stroke版本功能实现
**目标**：实现完整的多stroke版本功能（支持1-5个不同宽度）

#### 1.1 后端开发
- [ ] 创建`backend/png_stroke_processor.py`模块，复现edge脚本的描边逻辑
- [ ] 实现`PNGStrokeProcessor`类，包含描边核心算法（scipy和PIL双支持）
- [ ] 集成UTF-8字符支持和错误处理机制
- [ ] 修改`processor_core.py`，在inside生成后添加多stroke版本生成逻辑
- [ ] 实现支持数组参数的stroke处理逻辑（1-5个宽度值）
- [ ] 利用现有`PSDScaler`类实现PNG提取和重组功能
- [ ] 修改`app.py`，扩展API接口支持stroke数组参数
- [ ] 实现多stroke版本的文件命名和存储逻辑
- [ ] 扩展元数据结构，支持多版本映射和预览图路径

#### 1.2 前端开发
- [ ] 扩展类型定义，新增stroke相关接口（支持数组）
- [ ] 修改API服务层，支持stroke数组参数传递
- [ ] 实现动态stroke配置列表（+/-操作，最天5个）
- [ ] 添加输入验证（范围限制、重复检测）
- [ ] 修改预览界面，显示stroke版本数值列表
- [ ] 集成stroke配置到主应用界面

#### 1.3 技术实现详细要点

**`backend/png_stroke_processor.py`模块设计**：

1. **核心类结构**：
   - `PNGStrokeProcessor`类：主要描边处理器
   - `__init__()`：初始化参数（宽度、颜色、透明度）
   - `process_png()`：主入口方法，接收PIL Image对象或文件路径

2. **算法复现**：
   - `_has_scipy()`：检测scipy可用性
   - `_create_smooth_stroke_scipy()`：复现scipy高级算法（距离变换+高斯模糊）
   - `_create_smooth_stroke_pil()`：复现PIL备用算法（形态学操作）
   - `_apply_stroke_color()`：应用描边颜色和透明度

3. **错误处理和UTF-8支持**：
   - 完整复现edge脚本的UTF-8字符处理机制
   - 包含所有错误处理和日志输出
   - 保持与原脚本相同的参数验证和限制

4. **集成方式**：
   - 不对`scripts/png_edge_stroke.py`进行任何修改、移动或引用
   - 以backend模块形式集成，遵循项目架构规范
   - 通过`from backend.png_stroke_processor import PNGStrokeProcessor`进行引用

#### 1.4 测试验证
- [ ] 单元测试：`PNGStrokeProcessor`类的核心功能
- [ ] 算法一致性测试：与原始edge脚本结果对比
- [ ] 集成测试：完整的inside生成流程
- [ ] 功能测试：前后端接口联调

### 第二阶段：编辑对比功能
**目标**：实现编辑时的stroke版本对比功能

#### 2.1 透明预览图生成
- [ ] 开发stroke版本透明预览图生成功能
- [ ] 实现预览图存储和管理
- [ ] 优化预览图生成性能

#### 2.2 编辑界面扩展
- [ ] 扩展编辑界面的对比选项
- [ ] 实现stroke版本选择功能
- [ ] 添加透明叠加预览效果
- [ ] 完善版本标识和切换逻辑

#### 2.3 全流程测试
- [ ] 端到端测试：从配置到编辑的完整流程
- [ ] 用户体验测试
- [ ] 兼容性测试：确保与现有功能的兼容性

### 第三阶段：PNG数据复用性能优化
**目标**：解决PNG提取重复问题，实现性能优化

#### 3.1 核心优化方案
**问题识别**：
- 参考图生成需要遍历inside PSD的所有图层，调用`layer.topil()`将图层转换为PNG
- stroke版本生成需要使用`PSDScaler.extract_layers_from_psd()`提取所有图层为PNG
- 两个操作都需要对同一个inside PSD进行PNG提取，存在明显重复

**优化方案**：
- **一次PNG提取**：对inside PSD只进行一次完整的PNG图层提取
- **数据复用**：提取的PNG数据同时用于参考图生成和所有stroke版本生成
- **并行处理**：基于同一份PNG数据，并行生成多个stroke版本
- **内存优化**：减少重复的图层解码和PSD读取操作

#### 3.2 技术实现要点
- [ ] 设计统一的PNG数据提取和管理机制
- [ ] 重构参考图生成逻辑，使用共享PNG数据
- [ ] 重构stroke版本生成逻辑，基于共享PNG数据和`PNGStrokeProcessor`
- [ ] 优化`PNGStrokeProcessor`的内存使用和性能表现
- [ ] 实现自动内存管理和数据清理机制
- [ ] 性能测试和优化验证

#### 3.3 预期性能收益
- **IO操作减少**：从2次PSD读取减少到1次，节约50%的文件IO
- **处理时间优化**：估算节省30-50%的整体处理时间
- **内存效率提升**：减少重复的图层解码和内存占用
- **并行处理支持**：为多个stroke版本并行生成奠定基础

### 第四阶段：最终优化和完善
**目标**：高级性能优化和用户体验提升

#### 4.1 高级性能优化
- [ ] 优化stroke生成算法性能
- [ ] 实现智能缓存机制
- [ ] 优化文件存储和管理

#### 4.2 用户体验提升
- [ ] 添加配置预览功能
- [ ] 完善错误处理和用户提示
- [ ] 优化界面响应速度

#### 4.3 文档和维护
- [ ] 完善技术文档
- [ ] 创建用户使用指南
- [ ] 建立监控和日志机制

## 工作流程

1. **模板准备阶段**:
   - 用户上传PSD模板并配置stroke版本
   - 系统生成原始版本和多个stroke版本的inside PSD
   - 存储在`storage/inside/`目录，按版本分类管理

2. **图片处理阶段**:
   - 用户上传要处理的图片
   - 用户选择使用原始模板或特定stroke版本模板
   - 系统根据选择使用对应的inside PSD进行图片处理

3. **编辑对比阶段**:
   - 用户在编辑界面可选择不同stroke版本作为参考
   - 透明预览图提供叠加对比效果
   - 实时切换不同stroke版本查看效果

## 技术优势

1. **分阶段实施**: 降低开发风险，便于测试和调试
2. **复用现有架构**: 最大化利用现有的PNG处理脚本和PSD处理流程
3. **模块化设计**: 每个阶段相对独立，便于维护和扩展
4. **渐进式功能**: 用户可以在每个阶段完成后即时体验新功能

## 核心技术依赖

### 已有组件
- **`backend/psd_scaler.py`**: 提供`extract_layers_from_psd()`和`create_psd_from_dir()`方法
- **`backend/processor_core.py`**: 现有inside生成流程`_generate_restored_psd()`

### 新增组件
- **`backend/png_stroke_processor.py`**: 新建的描边处理模块，复现edge脚本的成熟算法
- **`PNGStrokeProcessor`类**: 支持scipy和PIL双算法，具备UTF-8字符支持

### 技术特性
- **UTF-8字符支持**: 所有组件均具备完整的UTF-8处理能力
- **双算法支持**: 描边脚本支持scipy高级算法和PIL备用算法
- **位置保持**: PNG提取和重组过程保持图层的正确位置和属性

### 实现方案优势
1. **技术可行性已验证**: 基于现有代码分析，方案100%可行
2. **架构整合性**: 在backend目录下复现描边逻辑，遵循项目架构规范，不依赖scripts
3. **代码复用率高**: 无需重写核心组件，直接集成现有功能
4. **性能优化潜力巨大**: PNG处理比PSD操作更高效，并存在PNG数据复用优化机会
5. **渐进式部署**: 可先实现单stroke版本，后扩展多版本支持
6. **维护性优秀**: backend模块化设计，便于单元测试和代码维护

### PNG数据复用优化亮点
**问题识别**: 参考图生成和stroke版本生成都需要对inside PSD进行PNG提取，存在操作重复。

**优化方案**:
- **一次提取，多处复用**: 对inside PSD只进行一次PNG提取，数据同时用于参考图和所有stroke版本
- **性能提升**: 减少50%的文件IO操作，节省30-50%的处理时间
- **并行处理**: 基于共享PNG数据，并行生成多个stroke版本
- **内存优化**: 减少重复的图层解码和内存占用

**实施优先级**: 在第三阶段进行，在完成所有功能后进行性能优化。