# 多Stroke版本Inside PSD生成技术方案

## 概述
本方案基于现有的PNG抽取和重组流程，在inside PSD生成过程中增加多stroke版本支持，用户可自定义多个不同宽度的描边版本，提供灵活的模板选择和编辑对比功能。

## 核心需求
1. **多版本配置**：用户上传模板时可配置0-5个不同宽度的stroke版本
2. **简化预览**：预览区域仅显示原始模板，文字提示stroke版本数量
3. **编辑对比**：编辑图片时可选择不同stroke版本的透明预览图作为参考

## 技术架构

### 现有流程分析
1. **PSD模板处理**: 使用`backend/psd_scaler.py`的`extract_layers_from_psd()`方法将PSD图层抽取为PNG
2. **图层变换**: 使用`backend/transformer_inside.py`对图层进行inside变换处理
3. **PSD重组**: 将处理后的PNG重新组装为inside PSD文件存储在`storage/inside/`

### 新增多stroke流程
在现有PNG抽取和PSD重组之间插入批量描边处理环节，利用已开发的`scripts/png_edge_stroke.py`脚本。

## 详细实现方案

### 1. 前端交互修改

#### 1.1 上传界面改造
- **Stroke配置管理区域**：在上传框上方新增stroke配置一览表
- **动态添加功能**：点击"+"按钮可添加新的stroke配置项（最多5个）
- **配置项内容**：每个配置项包含stroke宽度输入框（像素单位）和删除按钮
- **验证逻辑**：stroke宽度范围限制（1-10像素），重复宽度检测

#### 1.2 预览界面调整
- **原始模板显示**：预览区域显示原始模板图
- **Stroke版本列表**：在预览图旁显示配置的stroke版本数值（如：3px、5px、11px）
- **版本标识**：每个stroke版本显示具体像素数值，无需显示预览图

#### 1.3 编辑对比功能扩展
- **对比选项扩展**：在现有对比功能基础上增加stroke版本选择
- **透明预览图**：为每个stroke版本生成半透明预览图供对比参考
- **版本标识**：清晰标注每个对比选项的stroke宽度信息

### 2. 后端逻辑修改

#### 2.1 多版本生成逻辑详细步骤

##### 2.1.1 输入参数处理
1. **接收用户配置**：获取stroke宽度数组（如：[2, 5, 8]）
2. **参数验证**：检查数组长度不超过5个，每个宽度值在1-10像素范围内
3. **去重处理**：移除重复的宽度值，按数值大小排序
4. **配置存储**：将有效的stroke配置保存到元数据中

##### 2.1.2 PSD模板预处理
1. **模板文件验证**：检查输入PSD文件是否存在且格式正确
2. **创建工作目录**：在`storage/inside/temp/`下创建临时工作目录
3. **图层抽取**：使用`extract_layers_from_psd()`将PSD各图层导出为PNG文件
4. **图层信息记录**：保存每个图层的位置、尺寸、混合模式等属性信息

##### 2.1.3 inside变换处理
1. **图层inside变换**：对所有原始PNG文件执行inside变换处理（翻转、定位等）
2. **变换后PNG保存**：将完成inside变换的PNG文件保存到临时目录
3. **变换信息记录**：记录变换后每个part PNG的最终位置和属性信息

##### 2.1.4 原始inside版本生成
1. **PSD重组**：将完成inside变换的PNG文件重新组装为PSD格式
2. **文件保存**：保存为`{template_name}_inside_original.psd`
3. **路径记录**：将原始版本文件路径添加到返回结果中

##### 2.1.5 stroke版本批量生成
**对每个stroke宽度值执行以下步骤：**

1. **创建stroke子目录**：为当前宽度创建临时处理目录
2. **PNG描边处理**：
   - 遍历所有已完成inside变换的part PNG文件
   - 调用`png_edge_stroke.py`对每个变换后的PNG文件进行描边处理
   - 使用当前宽度值作为描边参数
   - 保存描边后的PNG文件到stroke子目录
3. **PSD重组**：将描边后的PNG文件重新组装为PSD格式
4. **文件命名保存**：保存为`{template_name}_inside_stroke_{width}px.psd`
5. **路径记录**：将当前stroke版本文件路径添加到返回结果中

##### 2.1.6 透明预览图生成
**对每个stroke版本执行：**

1. **预览图抽取**：从stroke版本PSD中抽取合成预览图
2. **透明度处理**：将预览图的不透明度调整为50%
3. **预览图保存**：保存为`{template_name}_stroke_{width}px_preview.png`
4. **预览图路径记录**：将预览图路径添加到元数据中

##### 2.1.7 元数据管理
1. **配置信息整理**：
   - 记录所有生成的stroke宽度值
   - 记录原始版本和各stroke版本的文件路径
   - 记录各stroke版本对应的预览图路径
   - 记录生成时间戳和模板ID
2. **元数据文件创建**：将配置信息保存为JSON格式的元数据文件
3. **元数据存储**：保存到`storage/inside/metadata/`目录

##### 2.1.8 临时文件清理
1. **工作目录清理**：删除`storage/inside/temp/`下的所有临时文件和目录
2. **PNG文件清理**：删除抽取的原始PNG文件和中间处理文件
3. **内存释放**：释放处理过程中占用的内存资源

##### 2.1.9 结果返回
1. **路径信息整理**：
   - 原始inside版本路径
   - 各stroke版本路径映射（宽度值 -> 文件路径）
   - 各stroke版本预览图路径映射
2. **状态信息**：返回生成成功的版本数量和任何错误信息
3. **元数据路径**：返回元数据文件路径供前端查询

#### 2.2 API接口调整
- **参数结构修改**：接收stroke配置数组而非单个配置
- **返回结果扩展**：返回原始版本路径 + 多个stroke版本路径映射
- **预览图生成**：为每个stroke版本生成透明度预览图供编辑时对比使用

#### 2.3 图片处理时的版本选择
- **版本选择参数**：在图片处理API中增加stroke版本选择参数
- **透明预览支持**：提供stroke版本的透明叠加预览功能

### 3. 存储结构调整

#### 3.1 文件命名和组织
- **原始版本**：`{template_name}_inside_original.psd`
- **多个stroke版本**：`{template_name}_inside_stroke_2px.psd`, `{template_name}_inside_stroke_5px.psd`等
- **预览图文件**：对应的透明预览图文件用于编辑时对比

#### 3.2 元数据结构扩展
- **stroke配置数组**：记录用户配置的所有stroke宽度
- **文件路径映射**：维护每个stroke宽度对应的文件路径
- **预览图路径**：记录每个版本对应的透明预览图路径

### 4. 用户体验设计

#### 4.1 配置管理交互
- **直观的添加/删除**：简单的UI操作添加和移除stroke配置
- **实时验证提示**：输入验证和重复检测的即时反馈
- **配置预览**：可选的stroke效果小图标预览

#### 4.2 编辑时的版本对比
- **版本切换**：便捷的stroke版本切换功能
- **透明叠加**：可调节透明度的叠加对比效果
- **版本标识**：清晰的版本标签和宽度显示

## 实现阶段划分

### 第一阶段：基础stroke功能实现
**目标**：实现单一stroke版本的基础功能

#### 1.1 后端开发
- [ ] 修改`transformer_inside.py`，新增基础stroke处理类
- [ ] 集成现有`png_edge_stroke.py`脚本到inside生成流程
- [ ] 修改`app.py`，扩展API接口支持stroke参数
- [ ] 实现基础的文件命名和存储逻辑

#### 1.2 前端开发
- [ ] 扩展类型定义，新增stroke相关接口
- [ ] 修改API服务层，支持stroke参数传递
- [ ] 创建基础stroke配置组件（单一stroke输入）
- [ ] 集成stroke配置到主应用界面

#### 1.3 测试验证
- [ ] 单元测试：stroke处理核心逻辑
- [ ] 集成测试：完整的inside生成流程
- [ ] 功能测试：前后端接口联调

### 第二阶段：多stroke版本支持
**目标**：扩展为支持多个stroke版本配置

#### 2.1 后端扩展
- [ ] 修改stroke处理逻辑，支持数组参数
- [ ] 实现批量生成多个stroke版本
- [ ] 完善文件命名规范（包含宽度标识）
- [ ] 扩展元数据结构，支持多版本映射

#### 2.2 前端界面升级
- [ ] 实现动态stroke配置列表（+/-操作）
- [ ] 添加输入验证（范围限制、重复检测）
- [ ] 修改预览界面，显示stroke版本数值列表
- [ ] 完善用户交互反馈

#### 2.3 测试优化
- [ ] 多版本生成测试
- [ ] 用户界面交互测试
- [ ] 性能影响评估

### 第三阶段：编辑对比功能
**目标**：实现编辑时的stroke版本对比功能

#### 3.1 透明预览图生成
- [ ] 开发stroke版本透明预览图生成功能
- [ ] 实现预览图存储和管理
- [ ] 优化预览图生成性能

#### 3.2 编辑界面扩展
- [ ] 扩展编辑界面的对比选项
- [ ] 实现stroke版本选择功能
- [ ] 添加透明叠加预览效果
- [ ] 完善版本标识和切换逻辑

#### 3.3 全流程测试
- [ ] 端到端测试：从配置到编辑的完整流程
- [ ] 用户体验测试
- [ ] 兼容性测试：确保与现有功能的兼容性

### 第四阶段：优化和完善
**目标**：性能优化和用户体验提升

#### 4.1 性能优化
- [ ] 优化stroke生成算法性能
- [ ] 实现智能缓存机制
- [ ] 优化文件存储和管理

#### 4.2 用户体验提升
- [ ] 添加配置预览功能
- [ ] 完善错误处理和用户提示
- [ ] 优化界面响应速度

#### 4.3 文档和维护
- [ ] 完善技术文档
- [ ] 创建用户使用指南
- [ ] 建立监控和日志机制

## 工作流程

1. **模板准备阶段**:
   - 用户上传PSD模板并配置stroke版本
   - 系统生成原始版本和多个stroke版本的inside PSD
   - 存储在`storage/inside/`目录，按版本分类管理

2. **图片处理阶段**:
   - 用户上传要处理的图片
   - 用户选择使用原始模板或特定stroke版本模板
   - 系统根据选择使用对应的inside PSD进行图片处理

3. **编辑对比阶段**:
   - 用户在编辑界面可选择不同stroke版本作为参考
   - 透明预览图提供叠加对比效果
   - 实时切换不同stroke版本查看效果

## 技术优势

1. **分阶段实施**: 降低开发风险，便于测试和调试
2. **复用现有架构**: 最大化利用现有的PNG处理脚本和PSD处理流程
3. **模块化设计**: 每个阶段相对独立，便于维护和扩展
4. **渐进式功能**: 用户可以在每个阶段完成后即时体验新功能