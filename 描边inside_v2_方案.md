# 描边 inside · v2 技术方案（中心锚点扩画布 + 裁切外扩）

## 一、目标与范围
- 目标：
  - 生成 stroke 版本前，以“中心锚点”将画布四面各外扩 w 像素，再进行描边，避免描边被画布边缘截断。
  - 用户裁剪阶段，若选择了 stroke，则以裁剪中心为基准四面各外扩 w 像素，确保与扩展画布的 stroke inside 完全匹配。
- 范围：仅对 stroke 版本与生成前裁剪交互进行增强；“原始 inside（restored.psd）”的既有流程与体验保持不变。

## 二、术语与约束
- 原始 inside：upload 后产生的 `restored.psd`（不扩展画布）。
- stroke inside（v2）：`{tpl}_stroke_{w}px.psd`（画布尺寸 = 原始尺寸 + 2w，中心锚点扩展），统一存放于 `inside_stroke_v2/` 目录。
- stroke 宽度单位：PSD 像素。
- 仅能选择已存在的 stroke 版本（不在生成阶段临时新建）。

## 三、后端改造
### 3.1 生成 stroke 版本（_generate_single_stroke_version）
采用“方案A：PNG 阶段扩展 + 描边 + 重组 PSD”的实现路径，确保流程可控且不需要新增依赖。

具体步骤（以某一宽度 w 为例）：
1) 图层提取（保持全画布尺寸）
   - 从源 inside PSD（restored.psd）提取每个图层为全尺寸 PNG（大小=W×H），图层像素粘贴到其原位置，透明背景填充。
2) 画布扩展（在 PNG 阶段）
   - 为每个图层 PNG 创建一个新画布（透明背景），尺寸为 `W' = W + 2w`、`H' = H + 2w`；
   - 将原 PNG 粘贴到新画布的偏移 `(w, w)` 位置（等效“中心锚点外扩”），保证内容保持居中不动、四周新增 w 像素安全边；
   - 记录新画布尺寸，供后续参考图与前端展示（可写入 `strokeMeta[w]`）。
3) 描边处理（仅对 part 图层）
   - 对“扩展后的” part 图层 PNG 运行描边（SciPy 优先、PIL 兜底），得到带描边的图层 PNG；
   - 非 part 图层（如 view）保持内容不变，仅使用扩展后的 PNG。
4) 重组 PSD（使用扩展后的 PNG 集）
   - 基于扩展后的 PNG 集合重组为 PSD，输出 `{tpl}_stroke_{w}px.psd`，其画布尺寸为 `W'×H'`，并存放到 `inside_stroke_v2/` 目录；
   - 图层坐标统一为 (0,0)（因为每个 PNG 都是全尺寸画布），视觉位置与原相对关系保持一致。
5) 生成参考图（stroke）
   - 基于“扩展后的 stroke inside PSD”渲染参考图，输出 `{tpl}_stroke_{w}px_reference.png`；
   - 参考图渲染逻辑与原参考图保持一致，仅输入 PSD 不同；PNG 尺寸与 `W'×H'` 一致。
6) 清理临时文件
   - 处理完成后清理临时目录（提取、扩展、描边中间 PNG）。

元数据（可选增强）：在模板记录中新增 `strokeMeta[w] = { width: W', height: H' }`，便于前端按实尺寸切换容器比例（若缺省，前端也可通过 view 尺寸 + 2w 估算）。

### 3.2 生成流程（generate_final_psd）
- 入参保持不变：`strokeWidth`（可选）。
- 选择逻辑：
  - 空/未选 → 使用原始 inside（restored.psd）。
  - 选中 w → 使用 `inside_stroke_v2/` 中“扩展画布”的 stroke inside `{tpl}_stroke_{w}px.psd`。
- 其他步骤（尺寸对齐、替换、最终变换、部件叠加）保持一致。
- 结果标注与命名：继续沿用 `_stroke_{w}px` 后缀与 `used_stroke_width` 索引字段。

## 四、前端改造
### 4.1 裁切阶段（UseModal）
- 当选择了 stroke w：
  - 以当前裁剪中心为基准，将裁剪矩形四面各外扩 w 像素。
  - 若外扩后的裁剪框超出原图边界：提示“裁切失败：选区外扩已超出原图可用范围，请减小选区或降低 Stroke 宽度”，并阻止继续生成。
  - 外扩成功时，导出（上传）图片的像素范围也随之增大，用于匹配“扩展画布”的 stroke inside，避免描边被截断。
- 未选择 stroke：维持现有裁切行为。

### 4.2 预览容器与叠加（裁切阶段）
- 预览容器比例：固定使用“原始 view”的比例 `view.width : view.height`，不随 Stroke 切换。
- 叠加参考图：仅显示“原始参考图”，保留开关与透明度；不在裁切阶段切换 Stroke 参考图。

### 4.3 裁切结果预览阶段（双图叠加示意）
- 执行两个裁切任务：
  - 原始裁切：按用户选框直接裁切；
  - 外扩裁切：以选框中心四面外扩 `w` 像素后裁切（仅当选择了 Stroke，越界规则见 4.1）。
- 预览展示（示意外扩边缘）：
  - 容器尺寸/比例以“外扩裁切结果”为基准（未选 Stroke 则以“原始裁切结果”为基准）。
  - 下层：外扩裁切结果（可轻微降低不透明度或加淡色底，突出边缘环）。
  - 上层：原始裁切结果（不透明），居中叠加；外扩新增的边缘环自然可见。
- 参考图叠加：可选择“原始参考图”或“所选 Stroke 参考图”进行叠加对比，样式沿用当前实现。

### 4.4 生成请求与阶段衔接
- 在“裁切确认”时读取用户勾选的 Stroke 宽度：
  - 选择了 w → 先执行 4.1 的“裁切外扩 + 越界校验”，通过后在请求中携带 `strokeWidth=w` 进入生成阶段；
  - 未选择 → 直接按原始流程进入生成阶段（不传 `strokeWidth`）。
- 仍向 `/api/generate` 传递 `strokeWidth`（当选择了 w）；不新增额外参数。
- 最终送去生成的是“外扩裁切结果”（未选 Stroke 则为“原始裁切结果”）。
- 下载命名与结果详情标注保持不变（含 `_stroke_{w}px` 与“使用模板：原始 / Stroke Npx”）。

## 五、API 与数据
- 生成接口：`POST /api/generate`，参数与语义保持不变（`strokeWidth` 选择 stroke inside）。
- 参考图：`GET /api/templates/{id}/stroke/{w}/reference` 返回“扩展画布尺寸”的 PNG。
- 模板元数据（可选）：`strokeMeta[w] = { width, height }`，便于前端容器按实尺寸展示。

## 六、兼容与迁移
- 不考虑旧版 stroke inside 的兼容改造：v2 产物与原 inside 并行存放（`inside_stroke_v2/` vs `inside/`）。
- 原始 inside：完全保持不变；生成时仅在选择了 Stroke 后使用 `inside_stroke_v2/` 下的 v2 版本。

## 七、校验与边界
- 裁切阶段：始终使用“原始参考图”叠加进行预览确认；外扩越界规则见 4.1。
- 选择 stroke=5px（生成路径）：
  - 参考图尺寸较原始增大（宽高各 +10px）。
  - 裁切选区外扩，对齐扩展画布；生成后描边不被截断。
  - 结果 ID/下载名包含 `_stroke_5px`，详情显示“Stroke 5px”。
- 选择原始：行为与当前一致。

## 八、风险与对策
- 比例错位：通过 `strokeMeta` 或严格按 view+2w 切换容器比例，确保前后端一致。
- 体积增加：画布外扩会带来 PSD/PNG 尺寸小幅增加；限制最大 w（如 10px），并复用已生成版本。
- 缺失文件：坚持“仅可选已存在版本”的策略；如文件被清理，提示恢复或重新上传模板生成。

## 九、实施阶段（建议）
### Phase 1（核心功能落地）
- 后端：实现 v2 Stroke（方案A），输出到 `inside_stroke_v2/`；参考图基于扩展画布生成；接口保持不变。
- 前端：
  - 裁切阶段仅原始参考图；新增 Stroke 勾选；确认时进行“外扩 + 越界校验（失败则阻止）”。
  - 裁切结果预览：双图叠加（下：外扩；上：原始）；可在此阶段选择叠加“原始/所选 Stroke”参考图。
  - 生成：仅提交“外扩裁切结果”（未选 Stroke 则用原始裁切）与 `strokeWidth`。
- 验收：原始路径不变；选 Stroke 时无边缘截断；命名/标注正确。

### Phase 2（体验与稳健性优化）
- 预览易读性：透明度微调、边界辅助线（可选）。
- 提示一致性与回退策略：参考图加载失败回退原始等。
- 性能优化（可选）：前端生成双预览的内存/耗时优化。

> 备注：本方案在分支 `extra_stroke` 实施，不影响现有主线功能与用户体验。
